var Pulsembox=new Class({Implements:Options,options:{overlay_duration:300,duration:600},overlayFx:false,imgFx:false,captionFx:false,boxFx:false,isVisible:false,direction:false,built:false,current:-1,caller:false,isReady:true,isHTML:false,boxWidth:0,boxHeight:0,galleries:{},spinnerimg:"/img/pbox/spinner.gif",initialize:function(a){this.setOptions(a);
this.overlay_duration=this.options.overlay_duration;this.duration=this.options.duration;},init:function(){$$("a.pulsembox").each(function(a){this.setGalleries(a);
a.addEvent("click",function(c){var b=new Event(c);b.stop();this.binder(a);}.bind(this));}.bind(this));},binder:function(c){var b=c.name||c.title||"";var d=c.rel||false;
var a=c.href||false;this.callera=c;this.show(b,a,d);},setGalleries:function(a){if(this.isImageURL(a.href)){if(group=a.get("rel")||false){if(group in this.galleries){if(this.galleries[group].every(function(b){return b.href!=a.href;
})){this.galleries[group][this.galleries[group].length]=a;}}else{this.galleries[group]=[a];}}}},build:function(){new Element("div#PboxOverlay",{styles:{opacity:0}}).addEvent("click",function(){this.close();
}.bind(this)).inject(document.body);this.overlayFx=new Fx.Tween("PboxOverlay",{property:"opacity",duration:this.overlay_duration,link:"cancel",transition:"quint:out"});
new Element("div#Pulsembox",{styles:{opacity:0}}).adopt(new Element("div#PboxHeader").adopt(new Element("a#PboxCloseButton",{html:"Cerrar",href:"javascript:;",title:'Tecla "ESC"',events:{click:function(){this.close();
}.bind(this)}}),new Element("div#PboxHeaderNav")),new Element("div#PboxPad")).inject(document.body);this.boxMoveFx=new Fx.Morph("Pulsembox",{duration:this.duration,link:"cancel",transition:"quint:out",fps:80});
this.boxFx=new Fx.Morph("Pulsembox",{duration:this.duration,link:"cancel",transition:"quint:out",fps:80});this.listen={scroll:function(){if(this.isVisible){this.showBox();
}}.bind(this),key:function(b){if(this.isVisible){var a=new Event(b);switch(a.code){case 27:this.close();break;case 39:if($("PboxNext")){this.change(this.next,this.rel);
}break;case 37:if($("PboxPrev")){this.change(this.prev,this.rel);}break;}}return false;}.bind(this),resize:function(){if(this.isVisible){this.showBox();
}}.bind(this)};$(window).addEvent("scroll",this.listen.scroll);$(document).addEvent("keyup",this.listen.key);$(window).addEvent("resize",this.listen.resize);
this.built=true;},showOverlay:function(){if(this.isVisible){return;}this.isVisible=true;$$("#Pulsembox,#PboxOverlay").setStyle("display","block");$("PboxOverlay").setStyle("background-image","url("+this.spinnerimg+")");
this.overlayFx.start(0.7);},show:function(m,c,n){if(!this.isReady){return false;}if(!this.built){this.build();}this.showOverlay();this.isReady=false;this.rel=n;
if(this.isImageURL(c)){this.isHTML=false;this.next=this.prev={caption:"",url:"",html:""};var d="";if(n){var o=false;var p=this.galleries[n].length;for(var h=0;
h<p;h++){var f=this.galleries[n][h];if(f.href==c){o=true;if(this.current!=-1){this.direction=h>this.current?">":"<";}this.current=h;d='<span id="PboxCounter">'+(h+1)+" / "+(this.galleries[n].length)+"</span>";
if(this.galleries[n][h-1]){this.prev=this.getInfo(h-1,this.galleries[n][h-1],"Prev","Anterior");}if(this.galleries[n][h+1]){this.next=this.getInfo(h+1,this.galleries[n][h+1],"Next","Siguiente");
}break;}}if((!o)&&p>0){this.current=0;this.isReady=true;this.change(this.getInfo(0,this.galleries[n][0],"",""),n);return;}}var l=$(new Image());l.addEvents({load:function(){$("PboxHeaderNav").set("html",this.prev.html+d+this.next.html);
$("PboxPad").adopt(new Element("a#PboxImageClose",{href:"javascript:;",title:"Clic para cerrar esta ventana",events:{click:function(){this.close();}.bind(this)}}));
var q=new Element("img#PboxImage",{src:c,alt:m}).inject("PboxImageClose");q.removeProperties("width","height");this.imgFx=new Fx.Tween(q,{property:"opacity",duration:this.duration,link:"cancel"}).set(0);
if($("PboxCaption")){$("PboxCaption").set("html",m);}else{new Element("div#PboxCaption",{html:m}).inject("PboxPad");}this.captionFx=new Fx.Tween("PboxCaption",{property:"opacity",duration:this.duration,link:"ignore"}).set(0);
var s=q.measure(function(){return this.getPosition("PboxPad");});var v=46+10+68;var i=window.getWidth()-20;var u=window.getHeight()-v;var r=l.width;var t=l.height;
if(r+(s.x*2)>i){t=t*((i-(s.x*2))/r);r=i-(s.x*2);if(t+(s.y*2)>u){r=r*((u-(s.y*2))/t);t=u-(s.y*2);}}else{if(t+(s.y*2)>u){r=r*((u-(s.y*2))/t);t=u-(s.y*2);
if(r+(s.x*2)>i){t=t*((i-(s.x*2))/r);r=i-(s.x*2);}}}this.boxWidth=r+(s.x*2);this.boxHeight=t+(s.y*2)+v-10;if(this.boxWidth<264){q.setStyle("width",r);this.boxWidth=264;
}if(this.prev.html){$("PboxPrev").addEvent("click",function(){this.change(this.prev,n);}.bind(this));}if(this.next.html){$("PboxNext").addEvent("click",function(){this.change(this.next,n);
}.bind(this));}this.showBox();}.bind(this),error:function(){this.isReady=true;if(this.rel){var i=this.galleries[this.rel].splice(this.current,1);if(this.direction){if(this.direction==">"&&this.next.html){this.change(this.next,this.rel);
return;}else{if(this.prev.html){this.change(this.prev,this.rel);return;}}if(this.direction=="<"&&this.prev.html){this.change(this.prev,this.rel);return;
}else{if(this.next.html){this.change(this.next,this.rel);return;}}}else{if(this.next.html){this.change(this.next,this.rel);return;}if(this.prev.html){this.change(this.prev,this.rel);
return;}}}this.close();}.bind(this)});l.src=c;}else{this.isHTML=true;var b=(matchURL=c.match(/\?(.+)/))?matchURL[1]:false;var g=this.getParams(b);g.width=g.width||false;
if(!g.width){g.width=window.getWidth()-(20+17);g.width=g.width<600?g.width:600;}var e=(g.width).toInt();var a=this.yplus=46+40;var k=window.getWidth()-(20+17);
var j=this.y=window.getHeight()-a;this.boxWidth=e>k?k:e;if(g.height){this.boxHeight=g.height;}$("PboxPad").setStyle("padding",0).adopt(new Element("div#PboxAjaxContent",{styles:{width:this.boxWidth}}));
if(c.indexOf("PboxInline")!=-1){g.inlineId=g.inlineId||false;if(!g.width){this.failure("No se especificó ancho de la ventana");}$("PboxAjaxContent").set("html",$(g.inlineId).get("html"));
this.resizeBox();}else{if(c.indexOf("PboxIframe")!=-1){if(!g.width){this.failure("No se especificó ancho de la ventana");}$("PboxAjaxContent").adopt(new Element("iframe",{src:c,frameborder:"no",framespacing:0}));
this.resizeBox();}else{new Request.HTML({method:"get",url:c,update:$("PboxAjaxContent"),onComplete:function(){this.resizeBox();}.bind(this),onFailure:function(){this.failure();
}.bind(this),evalScripts:true}).get();}}}},failure:function(a){this.isReady=true;a=a||"Hubo un problema para mostrar el contenido.";alert(a);this.close();
},showBox:function(){var a={width:this.boxWidth,height:this.boxHeight,left:(window.getScrollLeft()+(window.getWidth()-this.boxWidth)/2),top:(window.getScrollTop()+(window.getHeight()-this.boxHeight)/2)};
this.boxHeight=0;this.boxWidth=0;$("PboxOverlay").set("background-image","none");if($("Pulsembox").getStyle("opacity")==0){$("Pulsembox").setStyles(a);
}else{if(this.boxMoveFx){this.boxMoveFx.start(a);}}var b=function(){this.isReady=true;if(!this.isHTML){this.imgFx.start(1);this.captionFx.start(1);$("PboxOverlay").set("background-image","url("+this.spinnerimg+")");
}};if($("Pulsembox").getStyle("opacity")<1){this.boxFx.start({opacity:1}).chain(b.bind(this));}else{(b.bind(this))();}},resizeBox:function(){console.log("",this.boxHeight);
console.log("this.y",this.y);if(!this.boxHeight){$("PboxAjaxContent").setStyle("height","auto");var b=$("PboxAjaxContent").measure(function(){return this.getDimensions();
}),a,c;console.log("measured",b);this.boxHeight=b.y;}if(this.boxHeight>this.y){this.boxHeight=this.y;this.boxWidth+=17;}console.log("this.boxHeight",this.boxHeight);
$("PboxAjaxContent").setStyle("height",this.boxHeight);console.log("this.boxHeight finale",this.boxHeight);this.boxHeight=this.yplus-10+this.boxHeight;
this.showBox();},getParams:function(c){var e={};if(!c){return e;}var b=c.split(/[;&]/);for(var a=0;a<b.length;a++){var d=b[a].split("=");if(!d||d.length!=2){continue;
}e[unescape(d[0])]=unescape(d[1]).replace(/\+/g," ");}return e;},getInfo:function(a,c,d,b){return{idx:a,caption:c.name||c.title||"",url:c.href,html:"<a id='Pbox"+d+"' href='javascript:;' title='Tecla "+(d=="Prev"?"←":"→")+"'>"+b+"</a>"};
},change:function(b,a){if(!this.isReady){return false;}$("PboxPad").set("html","");if($("PboxCaption")){$("PboxCaption").set("html","");}this.callera=this.galleries[a][b.idx];
this.show(b.caption,b.url,a);},close:function(){if(!this.isReady){return false;}this.isReady=false;this.isVisible=false;if($("PboxPrev")){$("PboxPrev").removeEvents();
}if($("PboxNext")){$("PboxNext").removeEvents();}if($("PboxImageClose")){$("PboxImageClose").removeEvents();}this.boxFx.start({opacity:0}).chain(function(){$("PboxPad").set("html","");
$("PboxHeaderNav").set("html","");if($("PboxCaption")){$("PboxCaption").destroy();}this.overlayFx.start(0).chain(function(){$$("#PboxOverlay,#Pulsembox").setStyle("display","none");
this.isReady=true;}.bind(this));}.bind(this));},isImageURL:function(a){var c=(matchURL=a.match(/(.+)\?/))?matchURL[1]:a;var b=/\.(jpe?g|png|gif|bmp)/gi;
return c.match(b)?true:false;}});var pulsembox=new Pulsembox();window.addEvent("domready",function(){pulsembox.init();});